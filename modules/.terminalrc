#!/bin/bash

cfdir="$(realpath "$(dirname "$0")")"
source "$cfdir"/path.env

sourcer="${cfdir}/$(basename "$0")"
[[ ! -f "$sourcer".zwc || ! "$sourcer".zwc -nt "$sourcer" ]] && zcompile -UR "$sourcer"

traverse_dir() {
	local dir="$1"
	
	# parameter validation
	[ -z "$dir" ] && echo 'arg dir must be given' >&2 && return 1
	[ ! -d "$dir" ] && return 0

	for entry in "$dir"/*(N) "$dir"/.*(N); do

		# skipping specials
		[[ "$entry" = */.git* ]] && continue
		[[ "$entry" = */.zwc.d* ]] && continue
		
		# conditions on visit
		if [[ -d "$entry" && "$entry" = *.d ]]; then
			traverse_dir "$entry"
		elif [[ -f "$entry" && "$entry" = *.rc ]]; then
			echo "$entry"
		fi

	done
}

srcfiles="$(traverse_dir "$cfdir")"

while IFS= read -r -d $'\n' file; do
	filename="$(basename "$file")"
	zfile="$cfdir"/.zwc.d/"$filename"
	zwcfile="$zfile".zwc
	zdir="$(dirname "$zfile")"
	[[ -f "$zfile" && -f "$zwcfile" && "$zwcfile" -nt "$file" ]] && source "$zfile" && continue
	[ ! -d "$zdir" ] && mkdir -p "$zdir"
	echo "- compiling $filename"
	cp "$file" "$zfile" 1>/dev/null
	[ $? -ne 0 ] && "error... didn't source $file" && break
	zcompile -UR "$zfile"
	source "$zfile"
done < <(echo "$srcfiles")

unset filename file zfile zwcfile zdir sourcer cfdir srcfiles
unset -f traverse_dir
